---
layout: single
title:  "数据库事务的简单解释"
---

在解释事务前我们先看一个投票活动
![事务小故事](/assets/images/transaction.png)

图中有两个角色
* 用户(A,B,C,D)
* 记录员

假设，图中的场景是为某个活动投票。
* 用户可以投票
* 记录员需要记录投票，记录投票需要两部。
  * 首先，统计现有票数
  * 然后，增加票数（+1），将最新票数计入账本

有了场景后，我们分析几个不同情况
1. 用户A投票，记录员更新账本，用户B投票，记录员更新账本（投票和记账交叉进行）
   * 这个情况，投票数是不会出错的，用户通知记录员计票后，记录员计票完成才收到其他用户的投票通知。
2. 用户A投票，用户B投票，记录员更新账本
   * 这个情况，投票数是有可能出错的。两个用户同时要求记录员计票时，记录员首先统计一下现有票数，
   在更新票数过程中，记录员可能已经开始另一个用户投票的记账过程，这时拿到的现有票数就会有可能是
   用户A计票结果更新前的票数，增加B的投票情况并更新账本。这样总票数就丢失了。

情况2出现的原因是，我们没有对记录员的行为做规定，我们引入规定，制约记录员的行为。规定如下
1. 对一个用户的统计现有票数和更新账本不允许分开进行
2. 当记录员发现记错账了，应该立刻恢复到更新前的票数并通知用户投票失败或者启动重试。

有了上述规定，我们分析情况情况3
3. 用户A投票， 用户B投票.... , 遵守规定的记录员记账
   * 这个情况，投票数就不会出错了，因为有规定的制约，针对每个用户的投票，记录员必须完成统计现有
   票数，更新账本后才可以处理其他用户的投票通知。



铺垫差不多了，记录员的**行为准则**是这个小故事的重点。它保证了多用户投票过程记录员不会记错账。它就是事务在一个具体事务中的体现。

## 写在最后
写这篇文章的动机
* 周中讨论需求，被产品同学问到事务是啥？一两句话没有讲清楚，重温一遍。









