---
layout: single
title:  "Redis 数据复制"
---


# 命令
  Redis节点间数据同步的实现底层依赖[PSYNC](https://redis.io/commands/psync) 命令。
该命令的作用是建立主从节点的连接并进行数据交换。


# 数据复制


理解数据复制，我们先要理解两个定义**offsets**和**replicationID**
* offset简单理解就是数据同步完成的偏移量。
* replicationID根据官网的定义是一个比较大的伪随机字符串。当master发生变换或者offset增长过快超过
  预先设定的backlog的大小时会变。

## 复制流程
Redis的主从节点间是通过PSYNC命令交换replicationID和offsets的。当replicationID不变，offset增加时
采用增量复制，当replicationID变化，采用全量复制，全量复制又可以分为两部分。
* 第一部分，针对开始同步数据这个时间点的snapshot数据重放。
* 第二部分，重放开始到结束之间增量数据的，从库写入

这个设计是比较好理解的。当数据增量比较小时我们采用类似AOF的数据同步，当数据积压较多时，我们直接对压缩数据进行重放，减少网络开销

# Redis 对同步的优化
## 对于带TTL的key的同步方案
Redis的过期机制是利用一个计数器实例实现的。这也导致了数据同步无法同步TTL。
Redis的解决方案是从库的键过期删除是通过主库的键TTL的时候发送一条DEL命令实现的。
大部分场景这种从库的TTL策略是没有问题的。
但是当系统对一致性要求比较严格，还是会有问题的，比如
* 主库发送的DEL命令没来得及到从库，发生master切换
* 主库定期删除时间间隔内，读从库的过期键
* 键过期，但是读操作落到了从库，因为惰性删除 依然可以读
* 等等
当然，如果系统对这方面严谨性要求很高，最好还是采用数据库来做。

## 无磁盘同步
Redis从**2.8.18** 版本开始提供了无磁盘同步策略。相比之下，以前是将数据持久化到磁盘，再进行传输。
整个过程节省了落盘的开销。


